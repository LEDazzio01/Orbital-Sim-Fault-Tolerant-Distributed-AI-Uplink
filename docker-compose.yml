version: '3.8'

services:
  # 1. GROUND STATION (The Client)
  # Can ONLY see the Uplink. Cannot see the Node.
  ground-station:
    build:
      context: ./ground-station
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - UPLINK_HOST=uplink-service
      - UPLINK_PORT=8001
    networks:
      - terrestrial_mesh

  # 2. THE UPLINK (The Bridge/Chaos Proxy)
  # This is the ONLY service connected to both worlds.
  uplink-service:
    build:
      context: ./uplink-service
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      - ORBITAL_NODE_HOST=orbital-node
      - ORBITAL_NODE_PORT=8002
    networks:
      - terrestrial_mesh  # Incoming from Earth
      - orbital_mesh      # Outgoing to Space

  # 3. ORBITAL NODE (The Satellite)
  # Isolated in space. Constrained resources.
  orbital-node:
    build:
      context: ./orbital-node
      dockerfile: Dockerfile
    # Load the Azure keys from the local .env file
    env_file:
      - .env
    # No public ports! It is not accessible from localhost.
    networks:
      - orbital_mesh
    deploy:
      resources:
        limits:
          cpus: '0.50'    # Simulate slower, rad-hardened CPU
          memory: 512M    # Memory is heavy/expensive to launch
    depends_on:
      - uplink-service

  # Dev Container
  devcontainer:
    image: mcr.microsoft.com/devcontainers/python:3.12
    volumes:
      - .:/workspace:cached
    command: sleep infinity
    networks:
      - terrestrial_mesh
      - orbital_mesh

# 4. NETWORK TOPOLOGY
networks:
  terrestrial_mesh:
    driver: bridge
  orbital_mesh:
    driver: bridge
    internal: true # Disables external internet access for the satellite